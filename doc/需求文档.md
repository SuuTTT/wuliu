# 需求文档：仓库调配策略算法

## 1. 项目概述

本项目的目标是开发一个调配策略算法，用于确定从多个仓库分配商品到多个订单的最优策略。每个仓库和订单都有相应的优先级，并需要在满足各种约束条件的前提下进行调配。输入数据包括仓库-订单的单位运输时间矩阵，订单的需求数量数组，以及仓库-商品现有量矩阵。输出数据为仓库-订单的运输量矩阵和运输时间矩阵。

### 2. 输入/输出

#### 2.1 输入

- 单位运输时间三维矩阵 $X_{m \times n \times l}$: 表示每种商品从每个仓库到每个订单的单位运输时间（小时/量纲）。
- 需求量矩阵 $Y_{m \times l}$: 显示每个订单对每种商品（量纲）的需求。
- 库存矩阵 $Z_{n \times l}$: 提供每个仓库中每种商品（量纲）的库存。
- 订单优先级矩阵 $O_{m}$: 表示每个订单的优先级（无单位）。
- 仓库优先级矩阵 $W_{n}$: 表示每个仓库的优先级（无单位）。

注：m表示订单数量，n表示仓库数量，l表示商品种类数量。

#### 2.2 输出

- 运输量三维矩阵 $A_{m \times n \times l}$: 表示每种商品从每个仓库到每个订单的运输量（量纲）。
- 运输时间三维矩阵 $B_{m \times n \times l}$: 表示每种商品从每个仓库到每个订单的运输时间（小时）。
- 运输时间矩阵与运输量矩阵和单位运输时间矩阵有关，即 $B_{m \times n \times l} = A_{m \times n \times l} \circ X_{m \times n \times l}$


## 3. 约束条件

- 运输量需在现有量和需求量之间，即：0 <= 运输量 <= 现有量 和 0 <= 运输量 <= 需求量
- 同一个仓库是否可以同时满足多个订单
- 运输时间总量 <= 最晚时间 - 当前时间

形式化地，有以下约束条件：
 对于所有的j和l，有 $0 \leq \sum_{i=1}^{m} a_{ijl} \leq z_{jl}$
 对于所有的i和l，有 $0 \leq \sum_{j=1}^{n} a_{ijl} \leq y_{il}$

## 4. 分配规则

- 输入中只有一种商品
- 仓库和订单是多对多关系
- 订单不会都满足（给定的需求数量已经乘以满足度系数，但可能还无法满足，此时能分多少分多少，库存分完为止）
- 仓库顺序和订单顺序对应其优先级（算法给两种实现，1是严格参照优先级，2是优先考虑最短运输时间，3是考虑优先级和最短运输时间的权衡。通过配置文件）
- 运输时间为cost，不考虑出库时间，以及其它cost

## 5. 目标函数

我们的目标函数定义如下：

\[
\text{Maximize } Z = \alpha \cdot \left( \sum_{i=1}^{m} O_i \cdot \left( \sum_{l=1}^{L} \frac{\sum_{j=1}^{n} a_{ijl} \cdot W_j}{y_{il}} \right) \right) - \beta \cdot \left( \max_{i=1,l=1}^{m,L} \left( \max_{j=1}^{n} b_{ijl} \right) \right) - \text{penalty}
\]

其中：
- $\alpha$ 和 $\beta$ 是满足度和运输时间的权重，可以根据实际需求调整。
- $O$ 是订单优先级，$W$ 是仓库优先级。
- $a$ 是分配的物品数量，$y$ 是订单需求量。
- $b$ 是运输时间。

在这个目标函数中，第一项表示满足度，第二项表示运输时间，penalty表示惩罚项。具体惩罚项包括：
- 对违反约束的惩罚：算法通过引入惩罚项对违反约束的情况进行处理。例如，如果分配的货物数量超过了仓库的库存，或者如果满足的需求小于订单的实际需求，算法都会因违反这些约束而受到惩罚。
- 对仓库库存未使用完全的惩罚：该算法对仓库库存未使用完全的情况进行了惩罚，这体现了物流行业的一个常见需求，即尽量减少仓库中的剩余库存。

这些惩罚项的引入，使得算法在优化过程中，不仅考虑目标函数的最优化，也会避免违反实际约束，使得解更符合实际情况。

## 6. 未来要实现的功能

### 6.1 多商品支持
当前的调配策略算法只针对单一商品进行调度。在未来的改进中，我们希望能支持多种商品的同时调度，使算法更具普适性和实用性。我们需要扩展输入矩阵，包括运输时间矩阵、需求量矩阵和库存矩阵，以便处理多种商品。同时，我们可能需要更新目标函数和约束条件，以考虑多种商品间可能存在的相互影响和约束。

### 6.2 时间维度考虑
当前的调配策略算法并未考虑时间维度的影响，如仓库的出库时间冲突或者库存的实时变化。在未来的版本中，我们需要引入时间因素，以考虑出库时间、到达时间等因素。这将使我们的调度策略更加符合现实情况，而且能更好地优化整个物流网络的运作效率。

### 6.3 运输成本优化
当前的调配策略算法主要考虑运输时间，没有考虑到运输成本的影响。在未来，我们计划引入运输成本因素，以此优化整体的运输成本。这需要我们对现有的模型进行扩展，包括输入数据的扩展（例如引入运输成本数据）、目标函数和约束条件的更新等。

### 6.4 更丰富的分配规则
当前的分配规则相对简单，主要依赖于仓库和订单的优先级。在未来，我们希望能引入更丰富的分配规则，例如根据历史数据分析出的订单和仓库之间的配对优劣，或者根据实时情况动态调整的优先级等。这将使我们的算法更具灵活性，能更好地应对各种复杂的实际情况。

### 6.5 更多的优化目标
当前的调配策略算法主要目标是最大化总体满意度和最小化运输时间。在未来，我们希望能引入更多的优化目标，例如最小化运输成本、最大化满足的订单数量、最大化仓库的使用效率等。这将需要我们对现有的模型进行扩展，包括输入数据的扩展、目标函数和约束条件的更新等。


## 7. JSON数据示例

### 7.1 输入示例

```
{
	"spdd":[//商品订单
		{
			"ddnm":"", //订单内码
			"qynm":"", //企业内码
			"

spnm":"", //商品内码
			"sl":1,    //数量
			"lg":"",   //量纲
			"ckdata":[
				{
					"cknm":"",   //仓库内码
					"dwyssj":3.0 //单位运输时间
				},
				{
					"cknm":"",
					"dwyssj":3.0
				}
			]
		}
	],
	"ck":[
		{"cknm1":
			[{"spnm":"","sl":10,"lg":"枚"},{"spnm":"","sl":10,"lg":"枚"},{"spnm":"","sl":10,"lg":"枚"},{"spnm":"","sl":10,"lg":"枚"}]},
		{"cknm2":
			[{"spnm":"","sl":10,"lg":"枚"},{"spnm":"","sl":10,"lg":"枚"},{"spnm":"","sl":10,"lg":"枚"},{"spnm":"","sl":10,"lg":"枚"}]}
	]
}
```

### 7.2 输出示例

```
{
	"code":200,
	"data":[
		{
			"ddnm":"",//订单内码
			"cknm":"",//仓库内码
			"qynm":"",//企业内码
			"spnm":"",//商品内码
			"sl":1,//数量
			"lg":"枚",//量纲
			"dpsj":3.0 //调配时间=出库时间（恒为0）+运输时间
		}
	]
}
```
